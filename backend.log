INFO:     Will watch for changes in these directories: ['C:\\Users\\CW\\Desktop\\governer\\Book\\Book\\backend']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [4700] using WatchFiles
C:\Users\CW\Desktop\governer\Book\Book\backend\src\services\embedding.py:5: FutureWarning: 

All support for the `google.generativeai` package has ended. It will no longer be receiving 
updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
See README for more details:

https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md

  import google.generativeai as genai
INFO:     Started server process [8516]
INFO:     Waiting for application startup.
{"timestamp": "2025-12-17T13:35:23.218069Z", "level": "INFO", "logger": "src.main", "message": "Starting RAG Chatbot API...", "module": "main", "function": "lifespan", "line": 26}
C:\Users\CW\AppData\Local\Programs\Python\Python311\Lib\site-packages\psycopg_pool\pool_async.py:163: RuntimeWarning: opening the async pool AsyncConnectionPool in the constructor is deprecated and will not be supported anymore in a future release. Please use `await pool.open()`, or use the pool as context manager using: `async with AsyncConnectionPool(...) as pool: `...
  warnings.warn(
{"timestamp": "2025-12-17T13:35:24.680646Z", "level": "INFO", "logger": "src.db.postgres", "message": "Connected to Postgres with pool (min=2, max=10)", "module": "postgres", "function": "connect", "line": 37}
{"timestamp": "2025-12-17T13:35:24.680646Z", "level": "INFO", "logger": "src.main", "message": "Connected to Postgres", "module": "main", "function": "lifespan", "line": 35}
{"timestamp": "2025-12-17T13:35:24.791005Z", "level": "INFO", "logger": "src.db.qdrant", "message": "Connected to Qdrant at https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io", "module": "qdrant", "function": "connect", "line": 29}
{"timestamp": "2025-12-17T13:35:24.791005Z", "level": "INFO", "logger": "src.main", "message": "Connected to Qdrant", "module": "main", "function": "lifespan", "line": 39}
{"timestamp": "2025-12-17T13:35:40.399172Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: GET https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io:6333/collections \"HTTP/1.1 200 OK\"", "module": "_client", "function": "_send_single_request", "line": 1025}
{"timestamp": "2025-12-17T13:35:40.399172Z", "level": "INFO", "logger": "src.db.qdrant", "message": "Collection already exists: book_chunks_v1", "module": "qdrant", "function": "ensure_collection", "line": 62}
{"timestamp": "2025-12-17T13:35:40.586678Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: PUT https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io:6333/collections/book_chunks_v1/index?wait=true \"HTTP/1.1 200 OK\"", "module": "_client", "function": "_send_single_request", "line": 1025}
{"timestamp": "2025-12-17T13:35:40.586678Z", "level": "INFO", "logger": "src.main", "message": "Qdrant collection ready", "module": "main", "function": "lifespan", "line": 43}
INFO:     Application startup complete.
{"timestamp": "2025-12-17T13:36:51.022583Z", "level": "WARNING", "logger": "psycopg.pool", "message": "discarding closed connection: <psycopg.AsyncConnection [BAD] at 0x17d2e047850>", "module": "pool_async", "function": "_return_connection", "line": 791}
{"timestamp": "2025-12-17T13:36:51.022583Z", "level": "ERROR", "logger": "src.main", "message": "Postgres health check failed: the connection is lost", "module": "main", "function": "health_check", "line": 133}
{"timestamp": "2025-12-17T13:37:28.112482Z", "level": "INFO", "logger": "src.api.query", "message": "Processing query bc1aca3f-17e2-4a3d-b104-d332a3f1f16b: What is embodied cognition?...", "module": "query", "function": "submit_query", "line": 125}
{"timestamp": "2025-12-17T13:37:28.895425Z", "level": "INFO", "logger": "src.services.embedding", "message": "Generated 1 embeddings (model: models/text-embedding-004)", "module": "embedding", "function": "embed_batch", "line": 65}
{"timestamp": "2025-12-17T13:37:29.332870Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io:6333/collections/book_chunks_v1/points/search \"HTTP/1.1 200 OK\"", "module": "_client", "function": "_send_single_request", "line": 1025}
{"timestamp": "2025-12-17T13:37:29.332870Z", "level": "INFO", "logger": "src.db.qdrant", "message": "Found 5 results above threshold 0.7", "module": "qdrant", "function": "search", "line": 147}
{"timestamp": "2025-12-17T13:37:29.332870Z", "level": "INFO", "logger": "src.services.retrieval", "message": "Retrieved 5 chunks (threshold: 0.7, book_id: physical-ai-robotics, chapter: None)", "module": "retrieval", "function": "retrieve_chunks", "line": 81}
{"timestamp": "2025-12-17T13:37:29.565465Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 1s (attempt 1/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:37:30.760065Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 2s (attempt 2/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:37:32.972239Z", "level": "ERROR", "logger": "src.services.generation", "message": "Rate limit exceeded after 3 attempts", "module": "generation", "function": "generate_response", "line": 130}
{"timestamp": "2025-12-17T13:37:32.972239Z", "level": "ERROR", "logger": "src.api.query", "message": "Generation failed for query bc1aca3f-17e2-4a3d-b104-d332a3f1f16b: 429 You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits. To monitor your current usage, head to: https://ai.dev/usage?tab=rate-limit. \n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_input_token_count, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\nPlease retry in 25.666839675s. [links {\n  description: \"Learn more about Gemini API quotas\"\n  url: \"https://ai.google.dev/gemini-api/docs/rate-limits\"\n}\n, violations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_input_token_count\"\n  quota_id: \"GenerateContentInputTokensPerModelPerMinute-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerMinutePerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerDayPerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\n, retry_delay {\n  seconds: 25\n}\n]", "module": "query", "function": "submit_query", "line": 176}
{"timestamp": "2025-12-17T13:37:56.938177Z", "level": "INFO", "logger": "src.api.query", "message": "Processing query 706d01da-0c48-4c45-9ea6-213a868ef51e: What is embodied cognition?...", "module": "query", "function": "submit_query", "line": 125}
{"timestamp": "2025-12-17T13:38:00.482861Z", "level": "INFO", "logger": "src.services.embedding", "message": "Generated 1 embeddings (model: models/text-embedding-004)", "module": "embedding", "function": "embed_batch", "line": 65}
{"timestamp": "2025-12-17T13:38:01.080242Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io:6333/collections/book_chunks_v1/points/search \"HTTP/1.1 200 OK\"", "module": "_client", "function": "_send_single_request", "line": 1025}
{"timestamp": "2025-12-17T13:38:01.080242Z", "level": "INFO", "logger": "src.db.qdrant", "message": "Found 5 results above threshold 0.7", "module": "qdrant", "function": "search", "line": 147}
{"timestamp": "2025-12-17T13:38:01.080242Z", "level": "INFO", "logger": "src.services.retrieval", "message": "Retrieved 5 chunks (threshold: 0.7, book_id: physical-ai-robotics, chapter: None)", "module": "retrieval", "function": "retrieve_chunks", "line": 81}
{"timestamp": "2025-12-17T13:38:01.292328Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 1s (attempt 1/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:38:02.621189Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 2s (attempt 2/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:38:05.021034Z", "level": "ERROR", "logger": "src.services.generation", "message": "Rate limit exceeded after 3 attempts", "module": "generation", "function": "generate_response", "line": 130}
{"timestamp": "2025-12-17T13:38:05.021034Z", "level": "ERROR", "logger": "src.api.query", "message": "Generation failed for query 706d01da-0c48-4c45-9ea6-213a868ef51e: 429 You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits. To monitor your current usage, head to: https://ai.dev/usage?tab=rate-limit. \n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_input_token_count, limit: 0, model: gemini-2.0-flash-exp\nPlease retry in 53.752379041s. [links {\n  description: \"Learn more about Gemini API quotas\"\n  url: \"https://ai.google.dev/gemini-api/docs/rate-limits\"\n}\n, violations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerDayPerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerMinutePerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_input_token_count\"\n  quota_id: \"GenerateContentInputTokensPerModelPerMinute-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\n, retry_delay {\n  seconds: 53\n}\n]", "module": "query", "function": "submit_query", "line": 176}
{"timestamp": "2025-12-17T13:38:13.994176Z", "level": "INFO", "logger": "src.api.query", "message": "Processing query 4ee63200-a9aa-43b2-95ac-983d05f4000c: What topics are covered?...", "module": "query", "function": "submit_query", "line": 125}
{"timestamp": "2025-12-17T13:38:14.426999Z", "level": "INFO", "logger": "src.services.embedding", "message": "Generated 1 embeddings (model: models/text-embedding-004)", "module": "embedding", "function": "embed_batch", "line": 65}
{"timestamp": "2025-12-17T13:38:14.926862Z", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST https://3d790827-9d9b-444b-babb-dc8a5d2c035c.europe-west3-0.gcp.cloud.qdrant.io:6333/collections/book_chunks_v1/points/search \"HTTP/1.1 200 OK\"", "module": "_client", "function": "_send_single_request", "line": 1025}
{"timestamp": "2025-12-17T13:38:14.926862Z", "level": "INFO", "logger": "src.db.qdrant", "message": "Found 4 results above threshold 0.7", "module": "qdrant", "function": "search", "line": 147}
{"timestamp": "2025-12-17T13:38:14.926862Z", "level": "INFO", "logger": "src.services.retrieval", "message": "Retrieved 4 chunks (threshold: 0.7, book_id: physical-ai-robotics, chapter: None)", "module": "retrieval", "function": "retrieve_chunks", "line": 81}
{"timestamp": "2025-12-17T13:38:15.110282Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 1s (attempt 1/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:38:16.293086Z", "level": "WARNING", "logger": "src.services.generation", "message": "Rate limit hit, retrying in 2s (attempt 2/3)", "module": "generation", "function": "generate_response", "line": 123}
{"timestamp": "2025-12-17T13:38:18.476133Z", "level": "ERROR", "logger": "src.services.generation", "message": "Rate limit exceeded after 3 attempts", "module": "generation", "function": "generate_response", "line": 130}
{"timestamp": "2025-12-17T13:38:18.476133Z", "level": "ERROR", "logger": "src.api.query", "message": "Generation failed for query 4ee63200-a9aa-43b2-95ac-983d05f4000c: 429 You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits. To monitor your current usage, head to: https://ai.dev/usage?tab=rate-limit. \n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 0, model: gemini-2.0-flash-exp\n* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_input_token_count, limit: 0, model: gemini-2.0-flash-exp\nPlease retry in 40.153559481s. [links {\n  description: \"Learn more about Gemini API quotas\"\n  url: \"https://ai.google.dev/gemini-api/docs/rate-limits\"\n}\n, violations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerDayPerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_requests\"\n  quota_id: \"GenerateRequestsPerMinutePerProjectPerModel-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\nviolations {\n  quota_metric: \"generativelanguage.googleapis.com/generate_content_free_tier_input_token_count\"\n  quota_id: \"GenerateContentInputTokensPerModelPerMinute-FreeTier\"\n  quota_dimensions {\n    key: \"model\"\n    value: \"gemini-2.0-flash-exp\"\n  }\n  quota_dimensions {\n    key: \"location\"\n    value: \"global\"\n  }\n}\n, retry_delay {\n  seconds: 40\n}\n]", "module": "query", "function": "submit_query", "line": 176}
